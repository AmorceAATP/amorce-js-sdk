{"version":3,"sources":["../src/identity.ts","../src/envelope.ts","../src/client.ts","../src/index.ts"],"sourcesContent":["/**\n * Nexus Identity Module (Task 2.2)\n * Handles Ed25519 key management and signing using libsodium.\n * Compatible with both Browser and Node.js environments.\n */\n\nimport sodium from 'libsodium-wrappers';\n\nexport class IdentityManager {\n  private privateKey: Uint8Array;\n  public publicKey: Uint8Array;\n\n  private constructor(privateKey: Uint8Array, publicKey: Uint8Array) {\n    this.privateKey = privateKey;\n    this.publicKey = publicKey;\n  }\n\n  /**\n   * Initializes libsodium and generates a new random keypair.\n   */\n  static async generate(): Promise<IdentityManager> {\n    await sodium.ready;\n    const keypair = sodium.crypto_sign_keypair();\n    return new IdentityManager(keypair.privateKey, keypair.publicKey);\n  }\n\n  /**\n   * Loads an identity from a raw private key (Uint8Array).\n   */\n  static async fromPrivateKey(privateKey: Uint8Array): Promise<IdentityManager> {\n    await sodium.ready;\n    // Extract public key from private key\n    // FIX: Cast sodium to 'any' because the Type definition is missing this function\n    // even though it exists in the JS library.\n    const publicKey = (sodium as any).crypto_sign_ed25519_sk_to_pk(privateKey);\n    return new IdentityManager(privateKey, publicKey);\n  }\n\n  /**\n   * Signs a message (string or bytes) and returns the signature in Base64.\n   */\n  async sign(message: string | Uint8Array): Promise<string> {\n    await sodium.ready;\n    const signature = sodium.crypto_sign_detached(message, this.privateKey);\n    return sodium.to_base64(signature, sodium.base64_variants.ORIGINAL);\n  }\n\n  /**\n   * Verifies a signature against a public key.\n   * Static utility for validation.\n   */\n  static async verify(\n    message: string | Uint8Array,\n    signatureBase64: string,\n    publicKey: Uint8Array\n  ): Promise<boolean> {\n    await sodium.ready;\n    try {\n      const signature = sodium.from_base64(signatureBase64, sodium.base64_variants.ORIGINAL);\n      return sodium.crypto_sign_verify_detached(signature, message, publicKey);\n    } catch (e) {\n      return false;\n    }\n  }\n\n  /**\n   * Exports the Public Key to PEM format (PKIX).\n   * Matches Python's serialization.PublicFormat.SubjectPublicKeyInfo\n   */\n  getPublicKeyPem(): string {\n    // Ed25519 OID prefix for SubjectPublicKeyInfo (302a300506032b6570032100...)\n    // This is a raw construction of the ASN.1 header for Ed25519\n    const prefix =  new Uint8Array([\n      0x30, 0x2a, // Sequence, length 42\n      0x30, 0x05, // Sequence, length 5\n      0x06, 0x03, 0x2b, 0x65, 0x70, // OID: 1.3.101.112 (Ed25519)\n      0x03, 0x21, 0x00 // Bit String, length 33, 0 padding\n    ]);\n\n    const combined = new Uint8Array(prefix.length + this.publicKey.length);\n    combined.set(prefix);\n    combined.set(this.publicKey, prefix.length);\n\n    const b64 = sodium.to_base64(combined, sodium.base64_variants.ORIGINAL);\n\n    // Format as PEM (64 chars per line is standard, but simple block works for many parsers)\n    // We'll keep it simple: standard PEM header/footer\n    return `-----BEGIN PUBLIC KEY-----\\n${b64}\\n-----END PUBLIC KEY-----\\n`;\n  }\n}","/**\n * Nexus Envelope (Task 2.3 - Fixed)\n * Defines the strict NATP v0.1 data structure.\n * Handles canonical serialization and signing.\n * v1.1 Fix: Strips ASN.1 header from PEM public keys.\n */\n\nimport stringify from 'fast-json-stable-stringify';\nimport { v4 as uuidv4 } from 'uuid';\nimport sodium from 'libsodium-wrappers';\nimport { IdentityManager } from './identity';\n\nexport interface SenderInfo {\n  public_key: string; // PEM format\n  agent_id?: string;\n}\n\nexport interface SettlementInfo {\n  amount: number;\n  currency: string;\n  facilitation_fee: number;\n}\n\nexport class NexusEnvelope {\n  natp_version: string = \"0.1.0\";\n  id: string;\n  timestamp: number;\n  sender: SenderInfo;\n  payload: Record<string, any>;\n  settlement: SettlementInfo;\n  signature?: string;\n\n  constructor(sender: SenderInfo, payload: Record<string, any>) {\n    this.id = uuidv4();\n    // Python uses float seconds, JS uses ms. Convert to seconds.\n    this.timestamp = Date.now() / 1000;\n    this.sender = sender;\n    this.payload = payload;\n    this.settlement = { amount: 0, currency: 'USD', facilitation_fee: 0 };\n  }\n\n  /**\n   * Returns the canonical JSON bytes of the envelope WITHOUT the signature.\n   */\n  public getCanonicalJson(): Uint8Array {\n    const { signature, ...dataToSign } = this;\n    // fast-json-stable-stringify produces compact JSON (no spaces),\n    // matching Python's separators=(',', ':')\n    const jsonStr = stringify(dataToSign);\n    return new TextEncoder().encode(jsonStr);\n  }\n\n  /**\n   * Signs the envelope using the provided IdentityManager.\n   */\n  public async sign(identity: IdentityManager): Promise<void> {\n    const bytes = this.getCanonicalJson();\n    this.signature = await identity.sign(bytes);\n  }\n\n  /**\n   * Helper to parse a PEM public key back to Uint8Array for verification.\n   * FIX: We must strip the ASN.1 header to get the raw Ed25519 key.\n   */\n  private static pemToBytes(pem: string): Uint8Array {\n    // 1. Clean up the PEM string\n    const b64 = pem\n      .replace('-----BEGIN PUBLIC KEY-----', '')\n      .replace('-----END PUBLIC KEY-----', '')\n      .replace(/\\s/g, '');\n\n    // 2. Decode Base64\n    const fullBytes = sodium.from_base64(b64, sodium.base64_variants.ORIGINAL);\n\n    // 3. Strip ASN.1 Header (Fix)\n    // The SubjectPublicKeyInfo format is 44 bytes total (12 bytes header + 32 bytes key).\n    // Libsodium only wants the raw 32 bytes.\n    if (fullBytes.length > 32) {\n        return fullBytes.slice(fullBytes.length - 32);\n    }\n\n    return fullBytes;\n  }\n\n  /**\n   * Verifies the envelope's signature against its own sender public key.\n   */\n  public async verify(): Promise<boolean> {\n    if (!this.signature) return false;\n    await sodium.ready;\n\n    try {\n      const canonicalBytes = this.getCanonicalJson();\n      const publicKeyBytes = NexusEnvelope.pemToBytes(this.sender.public_key);\n\n      return IdentityManager.verify(canonicalBytes, this.signature, publicKeyBytes);\n    } catch (e) {\n      console.error(\"Verification failed:\", e);\n      return false;\n    }\n  }\n}","/**\n * Nexus Client Module (Task 2.4)\n * High-level HTTP client for the Nexus Agent Transaction Protocol (NATP).\n * Encapsulates envelope creation, signing, and transport using native fetch.\n */\n\nimport { IdentityManager } from './identity';\nimport { NexusEnvelope, SenderInfo } from './envelope';\n\nexport interface ServiceContract {\n  service_id: string;\n  provider_agent_id: string;\n  service_type: string;\n  // ... other fields can be added as needed\n  [key: string]: any;\n}\n\nexport class NexusClient {\n  private identity: IdentityManager;\n  private directoryUrl: string;\n  private orchestratorUrl: string;\n  private agentId?: string;\n  private apiKey?: string;\n\n  constructor(\n    identity: IdentityManager,\n    directoryUrl: string,\n    orchestratorUrl: string,\n    agentId?: string,\n    apiKey?: string\n  ) {\n    this.identity = identity;\n    // Remove trailing slashes for consistency\n    this.directoryUrl = directoryUrl.replace(/\\/$/, \"\");\n    this.orchestratorUrl = orchestratorUrl.replace(/\\/$/, \"\");\n    this.agentId = agentId;\n    this.apiKey = apiKey;\n  }\n\n  /**\n   * Helper to build and sign a standard envelope.\n   */\n  private async createEnvelope(payload: Record<string, any>): Promise<NexusEnvelope> {\n    // 1. Build Sender Info\n    const sender: SenderInfo = {\n      public_key: this.identity.getPublicKeyPem(),\n      agent_id: this.agentId\n    };\n\n    // 2. Create Envelope\n    const envelope = new NexusEnvelope(sender, payload);\n\n    // 3. Sign Envelope\n    await envelope.sign(this.identity);\n\n    return envelope;\n  }\n\n  /**\n   * P-7.1: Discover services from the Trust Directory.\n   */\n  public async discover(serviceType: string): Promise<ServiceContract[]> {\n    const url = `${this.directoryUrl}/api/v1/services/search?service_type=${encodeURIComponent(serviceType)}`;\n\n    try {\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      });\n\n      if (!response.ok) {\n        console.error(`Discovery failed: ${response.status} ${response.statusText}`);\n        return [];\n      }\n\n      return await response.json();\n    } catch (e) {\n      console.error(\"Discovery network error:\", e);\n      return [];\n    }\n  }\n\n  /**\n   * P-9.3: Execute a transaction via the Orchestrator.\n   * Wraps the payload in a signed NATP Envelope.\n   */\n  public async transact(serviceContract: ServiceContract, payload: Record<string, any>): Promise<any> {\n    if (!serviceContract.service_id) {\n      console.error(\"Invalid service contract: missing service_id\");\n      return null;\n    }\n\n    // 1. Prepare transaction payload (Routing info + Data)\n    const transactionPayload = {\n      service_id: serviceContract.service_id,\n      consumer_agent_id: this.agentId,\n      data: payload // The actual application data\n    };\n\n    // 2. Create Signed Envelope\n    const envelope = await this.createEnvelope(transactionPayload);\n\n    // 3. Send to Orchestrator\n    const url = `${this.orchestratorUrl}/v1/a2a/transact`;\n\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json'\n    };\n\n    if (this.apiKey) {\n      headers['X-ATP-Key'] = this.apiKey;\n    }\n\n    try {\n      const response = await fetch(url, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(envelope)\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`Transaction failed: ${response.status} - ${errorText}`);\n        return { error: `HTTP ${response.status}`, details: errorText };\n      }\n\n      return await response.json();\n\n    } catch (e) {\n      console.error(\"Transaction network error:\", e);\n      return null;\n    }\n  }\n}","/**\n * Nexus SDK for JavaScript/TypeScript\n * Version 0.1.0\n */\n\nexport const SDK_VERSION = \"0.1.0\";\n\n// Task 2.2: Export Identity Module\nexport * from './identity';\n\n// Task 2.3: Export Envelope Module\nexport * from './envelope';\n\n// Task 2.4: Export Client Module\nexport * from './client';\n\nconsole.log(`Nexus JS SDK v${SDK_VERSION} loaded.`);"],"mappings":"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","names":["sodium","sodium"]}